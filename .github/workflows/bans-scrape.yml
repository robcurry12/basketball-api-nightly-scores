name: BANS Nightly Scrape

on:
  schedule:
    # Run hourly (UTC). We gate execution so the job only proceeds at 2:00 AM America/New_York.
    - cron: "0 * * * *"
  workflow_dispatch: {}

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Only run at 2am ET
        shell: bash
        run: |
          HOUR=$(TZ="America/New_York" date +'%H')
          MIN=$(TZ="America/New_York" date +'%M')
          if [ "$HOUR" != "02" ] || [ "$MIN" != "00" ]; then
            echo "Not 2:00am ET (it is $HOUR:$MIN ET). Exiting."
            exit 0
          fi
          echo "It is 2:00am ET. Continuing."

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        shell: bash
        run: |
          npm ci || npm install
          npx playwright install --with-deps chromium

      - name: Run scraper and push to WordPress
        shell: bash
        env:
          BANS_PUSH_URL: ${{ secrets.BANS_PUSH_URL }}
          BANS_SECRET: ${{ secrets.BANS_SECRET }}
        run: |
          node scripts/bans-scrape-and-push.mjs
